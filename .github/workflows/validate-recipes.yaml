name: Validate Integration Recipes

on:
  pull_request:
    paths:
      - '**/recipe.yaml'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Set up Go 1.23.4
        uses: actions/setup-go@v5
        with:
          go-version: 1.23.4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git make yq

      - name: Validate changed recipes
        run: |
          set -e

          # Loop over changed recipe.yaml files in the PR diff
          for path in $(git diff --name-only HEAD^ | grep 'recipe.yaml'); do
            echo "ğŸ“„ Found modified recipe: $path"

            name=$(yq '.name' "$path")
            version=$(yq '.version' "$path")
            repo=$(yq '.repository' "$path")

            echo "ğŸ”— Cloning $repo at branch $version"
            git clone --depth 1 --branch "$version" "$repo" "$name"

            echo "ğŸ› ï¸ Building $name..."
            cd "$name"
            make
            cd ..

            echo "âœ… $name built successfully from $repo @ $version"
          done
